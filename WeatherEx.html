<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é…ä¿¡ç”¨ å¤©æ°—äºˆå ±</title>
  <style>
    :root {
      --bg-color: #1a1a1a;
      --card-bg: #222;
      --text-main: #fff;
      --text-sub: #aaa;
      --accent-color: #4da6ff;
      --temp-max: #ff6b6b;
      --temp-min: #4ecdc4;
      --border-color: #333;
    }
    body {
      margin: 0;
      background: #000; /* OBSç­‰ã®èƒŒæ™¯é€éç”¨ã«é»’ã€ã‚ã‚‹ã„ã¯ã‚¯ãƒ­ãƒã‚­ãƒ¼è‰²ã«ã—ã¦ã‚‚OK */
      color: var(--text-main);
      font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    }

    /* --- ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆé…ä¿¡ç”»é¢ã§ã¯ãƒˆãƒªãƒŸãƒ³ã‚°å¯¾è±¡ï¼‰ --- */
    .control-panel {
      background: #333;
      padding: 10px 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      border-bottom: 2px solid #555;
    }
    .control-panel h1 { font-size: 16px; margin: 0; color: #ddd; margin-right: auto; }
    button, select {
      background: #444; color: #fff; border: 1px solid #666;
      padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;
    }
    button:hover, select:hover { background: #555; }
    .status-pill {
      font-size: 14px; font-weight: bold; background: #222; padding: 5px 10px; border-radius: 4px;
    }

    /* --- é…ä¿¡è¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
    .broadcast-view {
      padding: 40px; /* ä½™ç™½ */
      max-width: 1200px;
      margin: 0 auto;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .weather-card {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .weather-card.show { opacity: 1; transform: translateY(0); }

    /* åœ°åŸŸãƒ»ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 25px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 15px;
    }
    .location-name {
      font-size: 48px; /* ã‹ãªã‚Šå¤§ãã */
      font-weight: 900;
      line-height: 1.1;
      letter-spacing: 0.05em;
    }
    .location-sub {
      font-size: 24px;
      color: var(--text-sub);
      margin-left: 15px;
      font-weight: normal;
    }
    .meta-info {
      text-align: right;
      font-size: 14px;
      color: var(--text-sub);
    }

    /* 3æ—¥åˆ†ã®ã‚°ãƒªãƒƒãƒ‰ */
    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    /* å€‹åˆ¥ã®æ—¥ä»˜ãƒ‘ãƒãƒ« */
    .day-panel {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .date-label {
      font-size: 20px;
      font-weight: bold;
      color: var(--text-sub);
      margin-bottom: 10px;
      display: block;
    }
    
    .weather-icon {
      width: 100px; /* ã‚¢ã‚¤ã‚³ãƒ³å·¨å¤§åŒ– */
      height: auto;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
      margin-bottom: 10px;
    }

    .telop {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* æ°—æ¸©è¡¨ç¤º */
    .temps {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 28px; /* æ¸©åº¦å¤§ãã */
      font-weight: 800;
      margin-bottom: 20px;
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 10px;
    }
    .temp-max { color: var(--temp-max); }
    .temp-min { color: var(--temp-min); }
    .temp-label { font-size: 12px; opacity: 0.7; font-weight: normal; display: block; }

    /* é™æ°´ç¢ºç‡ãƒ†ãƒ¼ãƒ–ãƒ« */
    .rain-table {
      width: 100%;
      font-size: 14px;
      border-collapse: collapse;
      color: #ccc;
    }
    .rain-table th { background: #333; padding: 4px; font-weight: normal; font-size: 11px; border-radius: 4px 4px 0 0; }
    .rain-table td { background: #2a2a2a; padding: 6px 0; font-weight: bold; border: 1px solid #333; }
    
    /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
    .error-msg {
      color: #ff6b6b; font-weight: bold; text-align: center; margin-top: 20px;
    }

  </style>
</head>
<body>

  <div class="control-panel">
    <h1>ğŸŒ¤ å¤©æ°—äºˆå ±ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</h1>
    <button id="prev">â—€ å‰ã®åœ°æ–¹</button>
    <select id="jump" aria-label="åœ°æ–¹ã‚’é¸æŠ"></select>
    <button id="next">æ¬¡ã®åœ°æ–¹ â–¶</button>
    <div style="flex-grow:1"></div>
    <span class="status-pill" id="counter">-- / --</span>
    <button id="toggle">â¸ ä¸€æ™‚åœæ­¢</button>
  </div>

  <div class="broadcast-view">
    <div class="weather-card" id="card">
      
      <div class="header-info">
        <div>
          <span class="location-name" id="area">Loading...</span>
          <span class="location-sub" id="city"></span>
        </div>
        <div class="meta-info" id="meta"></div>
      </div>

      <div class="forecast-grid" id="days"></div>
      <div class="error-msg" id="err" style="display:none"></div>

    </div>
  </div>

  <script>
    // è¨­å®šï¼šåˆ‡ã‚Šæ›¿ãˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    const ROTATE_MS = 10000; // 10ç§’ã«å»¶é•·ï¼ˆèª­ã‚€æ™‚é–“ã‚’ç¢ºä¿ï¼‰
    
    const AREAS = [
      { area:"åŒ—æµ·é“", city:"æœ­å¹Œ", id:"016010" },
      { area:"æ±åŒ—", city:"ä»™å°", id:"040010" },
      { area:"é–¢æ±ç”²ä¿¡", city:"æ±äº¬", id:"130010" },
      { area:"åŒ—é™¸", city:"é‡‘æ²¢", id:"170010" },
      { area:"æ±æµ·", city:"åå¤å±‹", id:"230010" },
      { area:"è¿‘ç•¿", city:"å¤§é˜ª", id:"270000" },
      { area:"ä¸­å›½", city:"åºƒå³¶", id:"340010" },
      { area:"å››å›½", city:"é«˜æ¾", id:"370000" },
      { area:"ä¹å·åŒ—éƒ¨", city:"ç¦å²¡", id:"400010" },
      { area:"ä¹å·å—éƒ¨", city:"é¹¿å…å³¶", id:"460010" },
      { area:"æ²–ç¸„", city:"é‚£è¦‡", id:"471010" },
    ];

    const API_BASE = "https://weather.tsukumijima.net/api/forecast/city/";
    const CACHE_TTL_MS = 30 * 60 * 1000; // 30åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥

    let idx = 0;
    let timer = null;
    let playing = true;

    // Elements
    const elCard = document.getElementById("card");
    const elArea = document.getElementById("area");
    const elCity = document.getElementById("city");
    const elMeta = document.getElementById("meta");
    const elDays = document.getElementById("days");
    const elCounter = document.getElementById("counter");
    const elErr = document.getElementById("err");
    const btnPrev = document.getElementById("prev");
    const btnNext = document.getElementById("next");
    const btnToggle = document.getElementById("toggle");
    const selJump = document.getElementById("jump");

    // Initialize Select Options
    AREAS.forEach((a, i) => {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `${a.area} - ${a.city}`;
      selJump.appendChild(opt);
    });

    // Cache Logic
    function cacheKey(id){ return `wx_cache_v2_${id}`; }
    function readCache(id){
      try{
        const raw = localStorage.getItem(cacheKey(id));
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !obj.t || !obj.data) return null;
        if(Date.now() - obj.t > CACHE_TTL_MS) return null;
        return obj.data;
      }catch{ return null; }
    }
    function writeCache(id, data){
      try{ localStorage.setItem(cacheKey(id), JSON.stringify({t: Date.now(), data})); }catch{}
    }

    // Fetch Logic
    async function fetchForecast(id){
      const cached = readCache(id);
      if(cached) return {data: cached, fromCache: true};

      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort(), 8000); // 8ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

      const res = await fetch(API_BASE + encodeURIComponent(id), {signal: ctrl.signal});
      clearTimeout(to);
      if(!res.ok) throw new Error(`HTTP Error ${res.status}`);
      const data = await res.json();
      writeCache(id, data);
      return {data, fromCache: false};
    }

    // Helper: Temp Formatting
    function fmtTemp(v){
      if(v === null || v === undefined) return "--";
      return String(v);
    }

    // Helper: Rain Table Generator
    function makeRainTable(rain){
      if(!rain) return "";
      // æ™‚é–“æ 
      const t00 = rain.T00_06 ?? "-";
      const t06 = rain.T06_12 ?? "-";
      const t12 = rain.T12_18 ?? "-";
      const t18 = rain.T18_24 ?? "-";
      
      return `
        <table class="rain-table">
          <tr>
            <th>00-06</th><th>06-12</th><th>12-18</th><th>18-24</th>
          </tr>
          <tr>
            <td>${t00}</td><td>${t06}</td><td>${t12}</td><td>${t18}</td>
          </tr>
        </table>
      `;
    }

    // Rendering
    function renderDays(forecasts){
      elDays.innerHTML = "";
      // æœ€å¤§3æ—¥åˆ†è¡¨ç¤º
      const list = (forecasts || []).slice(0, 3);

      list.forEach(f => {
        const max = fmtTemp(f?.temperature?.max?.celsius);
        const min = fmtTemp(f?.temperature?.min?.celsius);
        const iconUrl = f?.image?.url || "";
        const telop = f?.telop || "---";
        const dateLabel = f?.dateLabel || "";

        const div = document.createElement("div");
        div.className = "day-panel";
        div.innerHTML = `
          <span class="date-label">${dateLabel}</span>
          <img class="weather-icon" src="${iconUrl}" alt="å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³" />
          <div class="telop">${telop}</div>
          
          <div class="temps">
            <div>
              <span class="temp-label">æœ€é«˜</span>
              <span class="temp-max">${max}</span><span style="font-size:0.6em">Â°</span>
            </div>
            <div style="border-left:1px solid #444; width:1px; margin:0 5px;"></div>
            <div>
              <span class="temp-label">æœ€ä½</span>
              <span class="temp-min">${min}</span><span style="font-size:0.6em">Â°</span>
            </div>
          </div>

          ${makeRainTable(f?.chanceOfRain)}
        `;
        elDays.appendChild(div);
      });
    }

    async function show(i){
      idx = (i + AREAS.length) % AREAS.length;
      const a = AREAS[idx];

      // UI Updates
      elCounter.textContent = `${idx+1} / ${AREAS.length}`;
      selJump.value = String(idx);
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚»ãƒƒãƒˆï¼ˆcityIDã¯è¡¨ç¤ºã—ãªã„ï¼‰
      elArea.textContent = a.area;
      elCity.textContent = a.city; 
      
      elMeta.textContent = "æ›´æ–°ä¸­...";
      elErr.style.display = "none";

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
      elCard.classList.remove("show");
      
      try{
        // å°‘ã—é…å»¶ã•ã›ã¦ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³æ„Ÿã‚’å‡ºã™
        setTimeout(() => elCard.classList.add("show"), 50);

        const {data, fromCache} = await fetchForecast(a.id);
        const pubTime = data?.publicTimeFormatted || data?.publicTime || "";
        
        elMeta.textContent = `ç™ºè¡¨: ${pubTime} ${fromCache ? "(Cache)" : ""}`;
        renderDays(data?.forecasts);

      }catch(e){
        elMeta.textContent = "Error";
        elDays.innerHTML = "";
        elErr.textContent = `ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}`;
        elErr.style.display = "block";
        elCard.classList.add("show"); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ã‚«ãƒ¼ãƒ‰ã¯è¡¨ç¤º
      }
    }

    // Control Logic
    function next(){ show(idx + 1); }
    function prev(){ show(idx - 1); }

    function start(){
      stop();
      timer = setInterval(next, ROTATE_MS);
      playing = true;
      btnToggle.textContent = "â¸ åœæ­¢";
      btnToggle.style.background = "#444";
    }
    function stop(){
      if(timer) clearInterval(timer);
      timer = null;
      playing = false;
      btnToggle.textContent = "â–¶ å†é–‹";
      btnToggle.style.background = "#a33"; // åœæ­¢ä¸­ã¯èµ¤ã£ã½ã
    }

    // Event Listeners
    btnNext.addEventListener("click", () => { next(); if(playing) start(); });
    btnPrev.addEventListener("click", () => { prev(); if(playing) start(); });
    btnToggle.addEventListener("click", () => { playing ? stop() : start(); });
    selJump.addEventListener("change", (e) => {
      show(Number(e.target.value));
      if(playing) start();
    });

    // Initial Load
    show(0);
    start();
  </script>
</body>
</html>