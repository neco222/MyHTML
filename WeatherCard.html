<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å…¨å›½å¤©æ°—äºˆå ±ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼</title>
  <!-- â€»æœ¬ç•ªåˆ©ç”¨æ™‚ã¯ Tailwind ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€è‡ªã‚µãƒ¼ãƒãƒ¼ã§é…ä¿¡ã—ã¦ãã ã•ã„ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{background:transparent;}
    #weather-card{
      background-size:cover;background-position:center;background-repeat:no-repeat;
      transition:background-image .8s ease-in-out;color:#111;
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen">
  <div id="weather-card"
       class="w-80 p-6 rounded-2xl shadow-xl text-center overflow-hidden"></div>

<script>
// ä¸»è¦ 12 éƒ½å¸‚
const cities=[
  {name:'æœ­å¹Œ',lat:43.06417,lon:141.34694},
  {name:'ä»™å°',lat:38.26889,lon:140.87194},
  {name:'æ–°æ½Ÿ',lat:37.90222,lon:139.02361},
  {name:'æ±äº¬',lat:35.6895,lon:139.6917},
  {name:'åå¤å±‹',lat:35.18147,lon:136.90641},
  {name:'å¤§é˜ª',lat:34.69374,lon:135.50218},
  {name:'åºƒå³¶',lat:34.39639,lon:132.45944},
  {name:'é«˜çŸ¥',lat:33.55972,lon:133.53111},
  {name:'ç¦å²¡',lat:33.59018,lon:130.40169},
  {name:'é¹¿å…å³¶',lat:31.56028,lon:130.55806},
  {name:'é‚£è¦‡',lat:26.2125,lon:127.68111},
  {name:'çŸ³å£',lat:24.34,lon:124.155}
];

// ã‚³ãƒ¼ãƒ‰ â†’ çµµæ–‡å­—
const ICON={0:'â˜€ï¸',1:'ğŸŒ¤ï¸',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«ï¸',48:'ğŸŒ«ï¸',
            51:'ğŸŒ¦ï¸',53:'ğŸŒ¦ï¸',55:'ğŸŒ§ï¸',56:'ğŸŒ§ï¸',57:'ğŸŒ§ï¸',
            61:'ğŸŒ§ï¸',63:'ğŸŒ§ï¸',65:'ğŸŒ§ï¸',66:'ğŸŒ§ï¸',67:'ğŸŒ§ï¸',
            71:'ğŸŒ¨ï¸',73:'ğŸŒ¨ï¸',75:'ğŸŒ¨ï¸',77:'ğŸŒ¨ï¸',
            80:'ğŸŒ§ï¸',81:'ğŸŒ§ï¸',82:'ğŸŒ§ï¸',95:'â›ˆï¸',96:'â›ˆï¸',99:'â›ˆï¸'};
const DESC={0:'å¿«æ™´',1:'æ™´ã‚Œ',2:'è–„æ›‡',3:'æ›‡ã‚Š',45:'éœ§',48:'éœ§æ°·',
            51:'å¼±ã„éœ§é›¨',53:'éœ§é›¨',55:'å¼·ã„éœ§é›¨',
            56:'å¼±ã„å‡é›¨',57:'å¼·ã„å‡é›¨',
            61:'å¼±ã„é›¨',63:'é›¨',65:'å¼·ã„é›¨',
            66:'å¼±ã„å‡é›¨',67:'å¼·ã„å‡é›¨',
            71:'å¼±ã„é›ª',73:'é›ª',75:'å¼·ã„é›ª',77:'é›ªã‚ã‚‰ã‚Œ',
            80:'å¼±ã„ã«ã‚ã‹é›¨',81:'ã«ã‚ã‹é›¨',82:'æ¿€ã—ã„ã«ã‚ã‹é›¨',
            95:'é›·é›¨',96:'é›·é›¨(é›¹)',99:'æ¿€ã—ã„é›·é›¨(é›¹)'};

// èƒŒæ™¯ç”»åƒã‚«ãƒ†ã‚´ãƒª
const BG={
  sunny :'https://upload.wikimedia.org/wikipedia/commons/b/b1/Sunny_Sky.jpg',
  cloudy:'https://upload.wikimedia.org/wikipedia/commons/7/73/Cloudy_sky_%2826171935906%29.jpg',
  fog   :'https://upload.wikimedia.org/wikipedia/commons/c/ce/A_Foggy_Day_in_As-Samu.jpg',
  rain  :'https://images.unsplash.com/photo-1527766833261-b09c3163a791?auto=format&fit=crop&w=1600&q=80',
  snow  :'https://upload.wikimedia.org/wikipedia/commons/a/a5/A_bench_on_the_snow.jpg',
  storm :'https://upload.wikimedia.org/wikipedia/commons/e/ef/Lightning_at_Cape_Coral%2C_Florida.jpg'
};
function bgCat(code){
  if(code<=1) return 'sunny';
  if(code<=3) return 'cloudy';
  if(code===45||code===48) return 'fog';
  if((code>=51&&code<=67)||(code>=80&&code<=82)) return 'rain';
  if(code>=71&&code<=77) return 'snow';
  if(code>=95) return 'storm';
  return 'cloudy';
}

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
const fmt=d=>new Date(d).toLocaleDateString('ja-JP',{month:'numeric',day:'numeric',weekday:'short'});

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«å¼·ã„ãƒ•ã‚§ãƒƒãƒ
async function fetchWx(c){
  const url=`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&current_weather=true&forecast_days=1&timezone=Asia/Tokyo`;
  for(let attempt=0;attempt<4;attempt++){
    const res=await fetch(url);
    if(res.status===429){
      const retry=+res.headers.get('Retry-After')||2**attempt;
      await new Promise(r=>setTimeout(r,retry*1000));
      continue;
    }
    if(!res.ok) throw new Error(res.statusText);
    return res.json();
  }
  throw new Error('Rate limit exceeded');
}

// æç”»
const card=document.getElementById('weather-card');
function draw(j,c){
  const cw=j.current_weather,d=j.daily;
  card.style.backgroundImage=
    `linear-gradient(rgba(255,255,255,.6),rgba(255,255,255,.6)),url('${BG[bgCat(cw.weathercode)]}')`;
  card.innerHTML=`<h2 class="text-2xl font-bold mb-1">${c.name}</h2>
  <p class="text-xs mb-4">${fmt(d.time[0])} ã®äºˆå ±</p>
  <p class="mb-4 text-sm leading-relaxed">
    ${ICON[d.weathercode[0]]}Â ${DESC[d.weathercode[0]]}<br>
    æœ€é«˜ <span class="font-semibold">${d.temperature_2m_max[0]}â„ƒ</span> ï¼
    æœ€ä½ <span class="font-semibold">${d.temperature_2m_min[0]}â„ƒ</span><br>
    ä»Šæ—¥ã®é™æ°´ç¢ºç‡ï¼š<span class="font-semibold">${d.precipitation_probability_max[0]}%</span>
  </p>
  <p class="text-lg mb-1">
    ç¾åœ¨ï¼š<span class="font-semibold">${cw.temperature}â„ƒ</span>
    ${ICON[cw.weathercode]}Â ${DESC[cw.weathercode]}
  </p>`;
}

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const wxCache={};

async function preloadAll(){
  await Promise.all(cities.map(async c=>{
    try{wxCache[c.name]=await fetchWx(c);}catch(e){console.error(c.name,e);}  
  }));
}

let idx=0,sliderTimer;
function cycle(){
  const c=cities[idx];
  const data=wxCache[c.name];
  if(data) draw(data,c);
  idx=(idx+1)%cities.length;
}
function startSlider(){
  cycle();
  sliderTimer=setInterval(cycle,10_000);
}
function stopSlider(){
  if(sliderTimer) clearInterval(sliderTimer);
}

document.addEventListener('visibilitychange',()=>{
  document.visibilityState==='visible'?startSlider():stopSlider();
});

(async()=>{
  await preloadAll();
  startSlider();
  // 1 æ™‚é–“ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  setInterval(preloadAll,3_600_000);
})();
</script>
</body>
</html>